name: telegram message
on: [push]

jobs:
  build:
    name: Build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get commit details
        id: commit
        run: |
          SHORT_SHA=${GITHUB_SHA:0:7}
          TIMESTAMP=$(TZ='Asia/Phnom_Penh' date '+%Y-%m-%d %H:%M:%S')
          PROJECT_NAME="${{ github.event.repository.name }}"
          CAPITALIZED_PROJECT="${PROJECT_NAME^}"

          echo "short_sha=$SHORT_SHA" >> $GITHUB_OUTPUT
          echo "timestamp=$TIMESTAMP" >> $GITHUB_OUTPUT
          echo "project_name=$CAPITALIZED_PROJECT" >> $GITHUB_OUTPUT

      - name: Find zip file (only for zip releases)
        id: zipfile
        if: contains(github.event.head_commit.message, '[zip]')
        run: |
          # Find the usdt-guide-*.zip file
          USDT_GUIDE_ZIP=$(find . -name "usdt-guide-*.zip" -type f | head -1)
          if [ -n "$USDT_GUIDE_ZIP" ]; then
            # Remove the ./ prefix if present
            USDT_GUIDE_ZIP=${USDT_GUIDE_ZIP#./}
            echo "usdt_guide_zip_file=$USDT_GUIDE_ZIP" >> $GITHUB_OUTPUT
            echo "Found usdt-guide zip file: $USDT_GUIDE_ZIP"
          else
            echo "No usdt-guide-*.zip file found"
            exit 1
          fi

      - name: Send regular notification (without zip)
        if: success() && !contains(github.event.head_commit.message, '[zip]')
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          format: html
          disable_web_page_preview: true
          message: |
            ${{ github.actor != github.repository_owner && format('FYI: @{0}

            ', github.repository_owner) || '' }}ğŸš€ <b>Deployment Success!!</b> âœ¨ğŸ‰ğŸ¥³

            ğŸ“ <a href="https://github.com/${{ github.repository }}">${{ steps.commit.outputs.project_name }}</a>
            ğŸ‘¤ <b>${{ github.actor }}</b>
            ğŸ’¬ <i>${{ github.event.head_commit.message }}</i>
            ğŸ“ <code>${{ steps.commit.outputs.short_sha }}</code>
            ğŸ•’ ${{ steps.commit.outputs.timestamp }}

            ğŸ”— <a href="https://github.com/${{ github.repository }}/commit/${{ github.sha }}">Changes</a> | <a href="${{ github.event.repository.homepage }}">Live Site</a>

      - name: Send Telegram notification with zip file
        if: success() && contains(github.event.head_commit.message, '[zip]')
        run: |
          MESSAGE=$(cat << 'EOF'
          ${{ github.actor != github.repository_owner && format('FYI: @{0}

          ', github.repository_owner) || '' }}ğŸš€ <b>Deployment ${{ steps.commit.outputs.project_name }} Success!!</b> âœ¨ğŸ‰ğŸ¥³

          ğŸ•’ ${{ steps.commit.outputs.timestamp }}
          EOF
          )

          curl -F "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}" \
               -F "document=@${{ steps.zipfile.outputs.usdt_guide_zip_file }}" \
               -F "caption=${MESSAGE}" \
               -F "parse_mode=HTML" \
               "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendDocument"

      - name: Send failure notification
        if: failure()
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          format: html
          disable_web_page_preview: true
          message: |
            ${{ github.actor != github.repository_owner && format('FYI: @{0}

            ', github.repository_owner) || '' }}âŒ <b>Deployment Failed!!</b>

            ğŸ“ <a href="https://github.com/${{ github.repository }}">${{ steps.commit.outputs.project_name }}</a>
            ğŸ‘¤ <b>${{ github.actor }}</b>
            ğŸ’¬ <i>${{ github.event.head_commit.message }}</i>
            ğŸ“ <code>${{ steps.commit.outputs.short_sha }}</code>
            ğŸ•’ ${{ steps.commit.outputs.timestamp }}
            âŒ Check <a href="https://github.com/${{ github.repository }}/actions">GitHub Actions</a> for details

            ğŸ”— <a href="https://github.com/${{ github.repository }}/commit/${{ github.sha }}">Changes</a>